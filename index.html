<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stories of You</title>
  <meta name="description" content="Your voice, your story — preserved forever. Capture your memories in your own words with Stories of You." />
  <link rel="icon" href="favicon.ico" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Stories of You" />
  <meta property="og:description" content="Your voice, your story — preserved forever." />
  <meta property="og:image" content="https://storiesofyou.ai/og-image.jpg" />
  <meta property="og:url" content="https://storiesofyou.ai" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Stories of You" />
  <meta name="twitter:description" content="Your voice, your story — preserved forever." />
  <meta name="twitter:image" content="https://storiesofyou.ai/og-image.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand-navy:#0f2c4c;
      --brand-orange:#e09a1b;
      --brand-charcoal:#3d3528;
      --warm-light:#faf3e7;
      --warm-mid:#e0cba7;
    }
    .site-header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.82);backdrop-filter:saturate(140%) blur(10px);box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .hero-bg{background:radial-gradient(1200px 500px at 50% -200px,#fff7e9 0%,#fce8c8 50%,#e0cba7 100%)}
    .bg-warm-light{background-color:var(--warm-light)}
    .bg-warm-mid{background-color:var(--warm-mid)}
    .video-viewport{position:relative;width:100%;padding-bottom:56.25%;overflow:hidden;border-radius:.75rem;box-shadow:0 10px 25px rgba(0,0,0,.10);--crop:120%}
    .video-viewport video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border:0;display:block}
    .reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease,transform .6s ease}
    .reveal.visible{opacity:1;transform:none}
    .btn-primary{background-color:var(--brand-charcoal);color:#fff;transition:all 0.3s ease;position:relative;overflow:hidden}
    .btn-primary:hover{background-color:#5a4d3a;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .btn-primary:disabled{background-color:#9ca3af;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-secondary{background:#fff;color:var(--brand-charcoal);border:2px solid var(--brand-charcoal);transition:all 0.3s ease}
    .btn-secondary:hover{background:#f7f2eb;transform:translateY(-1px)}
    .btn-secondary:disabled{background:#f9fafb;color:#9ca3af;border-color:#d1d5db;cursor:not-allowed;transform:none}
    .icon{width:52px;height:52px;display:inline-block;color:var(--brand-navy)}
    .icon-accent{color:var(--brand-orange)}
    
    /* IMPROVED: Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* IMPROVED: Progress indicator */
    .upload-progress {
      background: #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
      border-left: 4px solid var(--brand-orange);
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin: 1rem 0;
      font-size: 0.875rem;
    }
    
    /* FIXED: Mobile responsive progress steps - only change needed */
    @media (max-width: 640px) {
      .progress-steps {
        font-size: 0.75rem;
      }
    }
    
    .progress-step {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      color: #6b7280;
      position: relative;
    }
    
    .progress-step.active {
      color: var(--brand-orange);
      font-weight: 600;
    }
    
    .progress-step.completed {
      color: var(--brand-navy);
    }
    
    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
      transform: translateY(-50%);
      z-index: -1;
    }
    
    .progress-step.completed:not(:last-child)::after {
      background: var(--brand-orange);
    }
    
    /* FAQ Styles */
    .faq-tab {
      padding: 8px 16px;
      border: 2px solid var(--brand-charcoal);
      background: white;
      color: var(--brand-charcoal);
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .faq-tab:hover {
      background: var(--brand-charcoal);
      color: white;
    }
    
    .faq-tab.active {
      background: var(--brand-charcoal);
      color: white;
    }
    
    .faq-category {
      display: none;
    }
    
    .faq-category.active {
      display: block;
    }
    
    .faq-question:hover .faq-icon {
      color: var(--brand-orange);
    }
    
    .faq-item.open .faq-icon {
      transform: rotate(180deg);
      color: var(--brand-orange);
    }
    
    .faq-answer {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">

  <!-- Header -->
  <header class="site-header">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
      <a href="/">
        <img src="logo.png" alt="Stories of You logo" class="h-8 w-auto rounded-sm" />
      </a>
      <nav class="hidden md:flex items-center space-x-6">
        <a href="#faq" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">FAQ</a>
        <a href="about.html" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">About</a>
        <a href="privacy.html" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Privacy</a>
        <button id="openLoginModal" class="btn-secondary px-4 py-2 text-sm rounded-lg">Login</button>
        <button id="openRecorderNav" class="btn-primary px-4 py-2 text-sm rounded-lg">Record Story</button>
      </nav>
      <!-- Mobile menu button -->
      <button id="mobileMenuBtn" class="md:hidden text-gray-600 hover:text-gray-900">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <!-- Mobile menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-white border-t border-gray-200">
      <div class="px-6 py-3 space-y-3">
        <a href="#faq" class="block text-sm text-gray-600 hover:text-gray-900">FAQ</a>
        <a href="about.html" class="block text-sm text-gray-600 hover:text-gray-900">About</a>
        <a href="privacy.html" class="block text-sm text-gray-600 hover:text-gray-900">Privacy</a>
        <button id="openLoginMobile" class="btn-secondary px-4 py-2 text-sm rounded-lg w-full text-left">Login</button>
        <button id="openRecorderMobile" class="btn-primary px-4 py-2 text-sm rounded-lg w-full text-left">Record Story</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero-bg">
    <div class="mx-auto max-w-7xl px-6 py-14 text-center">
      <img src="logo.png" alt="Stories of You" class="h-12 w-auto mx-auto mb-4" />
      <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 leading-tight">Your voice, your story — preserved forever.</h1>
      <p class="mt-5 text-lg text-gray-900/80 max-w-2xl mx-auto">
        Stories of You makes it easy to record and share your memories in your own voice,
        creating a legacy your loved ones can treasure for generations.
      </p>

      <div class="mt-8 max-w-3xl mx-auto reveal">
        <div class="video-viewport">
          <video
            id="introVideo"
            autoplay
            muted
            playsinline
            controls
            preload="metadata"
            poster="og-image.jpg"
          >
            <source src="https://d4al2emvsw1mr.cloudfront.net/StoriesOfYouTest2.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      </div>

      <div class="mt-8 flex items-center justify-center">
        <button id="openRecorder" class="btn-primary px-8 py-4 text-lg rounded-xl shadow transition">
          Record a Story (beta)
        </button>
      </div>
    </div>
  </section>

  <!-- How It Works -->
  <section class="bg-warm-light py-16">
    <div class="max-w-6xl mx-auto px-6 text-center">
      <h2 class="text-3xl font-bold mb-10 reveal">How It Works</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="reveal">
          <span class="icon">
            <svg viewBox="0 0 24 24" fill="currentColor" class="w-full h-full"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 1 1-10 0H5a7 7 0 0 0 14 0h-2ZM11 19h2v3h-2v-3Z"/></svg>
          </span>
          <h3 class="text-xl font-semibold mt-2">Record</h3>
          <p class="text-gray-700">Answer a simple prompt and record your voice right from your phone or computer.</p>
        </div>
        <div class="reveal">
          <span class="icon icon-accent">
            <svg viewBox="0 0 24 24" fill="currentColor" class="w-full h-full"><path d="M12 2l1.8 5.4L19 9l-5.2 1.6L12 16l-1.8-5.4L5 9l5.2-1.6L12 2Zm7 9 1 3-3 1 3 1-1 3 2-2 3 1-2-2 2-2-3 1-2-2Z"/></svg>
          </span>
          <h3 class="text-xl font-semibold mt-2">Review</h3>
          <p class="text-gray-700">Listen back and make sure it's exactly how you want it before you submit.</p>
        </div>
        <div class="reveal">
          <span class="icon">
            <svg viewBox="0 0 24 24" fill="currentColor" class="w-full h-full"><path d="M20 7h-2.2a3 3 0 1 0-5.8-1c0 .34.07.67.2 1H11.8a3 3 0 1 0-5.8-1 3 3 0 0 0 .2 1H4a1 1 0 0 0-1 1v3h18V8a1 1 0 0 0-1-1Zm-8-2a1 1 0 1 1 2 0 1 1 0 0 1-2 0ZM8 5a1 1 0 1 1 2 0 1 1 0 0 1-2 0ZM3 12v7a2 2 0 0 0 2 2h5v-9H3Zm11 0v9h5a2 2 0 0 0 2-2v-7h-7Z"/></svg>
          </span>
          <h3 class="text-xl font-semibold mt-2">Share</h3>
          <p class="text-gray-700">Your story is preserved and can be shared with loved ones — forever.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Testimonials -->
  <section class="bg-white py-16">
    <div class="max-w-6xl mx-auto px-6">
      <h2 class="text-3xl font-bold text-center mb-10 reveal" style="color:var(--brand-navy)">Future Testimonials</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <figure class="reveal rounded-xl border border-black/5 shadow-sm p-6 bg-warm-light">
          <blockquote class="text-gray-800 italic">"I didn't realize how much I missed my dad's laugh until I heard it here. Best gift we've given our kids."</blockquote>
          <figcaption class="mt-4 text-sm text-gray-600">— Sarah M., daughter</figcaption>
        </figure>
        <figure class="reveal rounded-xl border border-black/5 shadow-sm p-6 bg-warm-light">
          <blockquote class="text-gray-800 italic">"It took five minutes, and now my grandkids will always know my voice and our family stories."</blockquote>
          <figcaption class="mt-4 text-sm text-gray-600">— Robert T., grandfather</figcaption>
        </figure>
        <figure class="reveal rounded-xl border border-black/5 shadow-sm p-6 bg-warm-light">
          <blockquote class="text-gray-800 italic">"My mom hates being on camera, but this made it easy. She just talked — and it was beautiful."</blockquote>
          <figcaption class="mt-4 text-sm text-gray-600">— Jason L., son</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="bg-warm-light py-16" id="faq">
    <div class="max-w-4xl mx-auto px-6">
      <h2 class="text-3xl font-bold text-center mb-4 reveal" style="color:var(--brand-navy)">Frequently Asked Questions</h2>
      <p class="text-center text-gray-600 mb-12 reveal">Everything you need to know about preserving your family's stories</p>
      
      <!-- FAQ Category Tabs -->
      <div class="flex flex-wrap justify-center gap-4 mb-8">
        <button class="faq-tab active" data-category="gift-givers">For Gift Givers</button>
        <button class="faq-tab" data-category="storytellers">For Storytellers</button>
        <button class="faq-tab" data-category="privacy">Privacy & Security</button>
        <button class="faq-tab" data-category="pricing">Pricing & Plans</button>
        <button class="faq-tab" data-category="support">Technical Support</button>
      </div>

      <!-- FAQ Categories -->
      
      <!-- For Gift Givers -->
      <div class="faq-category active" id="gift-givers">
        <div class="space-y-4">
          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">What is Stories of You?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Stories of You is a unique gift that helps your loved ones record and preserve their personal memories in their own voice. Guided prompts make it easy for them to share life stories, reflections, and experiences that will be cherished for generations.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">How does gifting work?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              While we're in beta, anyone can record stories and have their stories cataloged and sent to their email. After launch, you can choose a plan, purchase a gift subscription, and we'll send the recipient an invitation to create their account. Once set up, they can begin recording right away.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Who can hear the recordings?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              By default, only the recipient (and you, if they choose to share) can access recordings. The storyteller controls who sees or hears their stories.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Do gift recipients need a credit card to redeem?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              No. Your gift covers the full subscription period, with no payment required from the recipient.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Can I help the recipient record stories?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes. You can help them choose prompts, assist with recording, or even sit with them during the storytelling process.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Can I upload an existing recording instead of recording live?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Currently, all recordings must be made directly through our platform to ensure the best quality and experience.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Can I change who the gift is for?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes. You can update the recipient information anytime before it's redeemed.
            </div>
          </div>
        </div>
      </div>

      <!-- For Storytellers -->
      <div class="faq-category" id="storytellers">
        <div class="space-y-4">
          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Do I need special equipment to record?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              No. You can record directly from your smartphone, tablet, or computer — no special gear required.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">How long can each recording be?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Each story can be up to 10 minutes long — enough to share meaningful details without feeling rushed.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Can I add photos or other media?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes. You can upload a photo alongside your story to give it visual context.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Do I have to use the provided prompts?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              No. Prompts are there to inspire you, but you're free to record any story you choose.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Who can hear my recordings?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              By default, only you (and the person who gifted the subscription, if you choose) can access your recordings.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Can I delete a recording?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes. You can delete any story at any time.
            </div>
          </div>
        </div>
      </div>

      <!-- Privacy & Security -->
      <div class="faq-category" id="privacy">
        <div class="space-y-4">
          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">How is my data protected?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              All recordings are stored securely with encryption. We never sell or share your data without permission. More information can be found on our <a href="privacy.html" class="text-orange-600 hover:underline">privacy page</a>.
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing & Plans -->
      <div class="faq-category" id="pricing">
        <div class="space-y-4">
          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">How much does it cost?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              During beta, Stories of You is free to try. Pricing will be announced before full launch.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Is there a free trial?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes, during beta the entire service is free to use.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">What happens to my stories after beta?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              All stories recorded during beta will be preserved and accessible when we launch.
            </div>
          </div>
        </div>
      </div>

      <!-- Technical Support -->
      <div class="faq-category" id="support">
        <div class="space-y-4">
          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">I'm having trouble recording — what should I do?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Make sure your browser or app has microphone permissions enabled. You can also refresh the page or restart your device.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Does it work on all devices?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Yes. Stories of You works on most modern browsers and devices, including iPhone, Android, Windows, and Mac.
            </div>
          </div>

          <div class="faq-item">
            <button class="faq-question w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors flex justify-between items-center">
              <span class="font-semibold text-gray-900">Who can I contact for help?</span>
              <svg class="faq-icon w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="faq-answer hidden p-4 text-gray-700 bg-white border-l-4" style="border-color:var(--brand-orange)">
              Email us at support@storiesofyou.ai and we'll respond within one business day.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="bg-warm-mid py-16">
    <div class="max-w-4xl mx-auto text-center px-6">
      <h2 class="text-3xl font-bold text-gray-900 reveal">Ready to tell your story?</h2>
      <p class="mt-4 text-lg text-gray-800 reveal">It takes just a few minutes to record something that will last forever.</p>
      <button id="openRecorderBottom" class="btn-secondary mt-8 px-8 py-4 text-lg rounded-xl shadow transition reveal">
        Record a Story (beta)
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-300 py-8">
    <div class="max-w-7xl mx-auto px-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="Stories of You logo" class="h-7 w-auto rounded-sm" />
        <span class="text-sm tracking-wide">© <span id="year"></span> Stories of You. All rights reserved.</span>
      </div>
      <a href="privacy.html" class="text-sm hover:text-white opacity-80">Privacy</a>
    </div>
  </footer>

  <!-- Recorder Modal -->
  <div id="recModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] p-4 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[95vh] flex flex-col my-4">
      <div class="flex items-center justify-between p-4 border-b flex-shrink-0">
        <div class="flex items-center gap-2">
          <img src="logo.png" alt="Stories of You" class="h-6 w-auto" />
          <span class="text-sm font-semibold" style="color:var(--brand-navy)">Record Your Story</span>
        </div>
        <button id="recClose" class="text-gray-400 hover:text-gray-600 text-2xl leading-none" aria-label="Close">&times;</button>
      </div>
      <div class="p-5 space-y-4 overflow-y-auto flex-1">
        <!-- Identity -->
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-600">Your name <span class="text-red-600">*</span></label>
            <input id="recName" type="text" class="w-full border rounded-md px-3 py-2" required />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Email <span class="text-red-600">*</span></label>
            <input id="recEmail" type="email" class="w-full border rounded-md px-3 py-2" required />
          </div>
        </div>

        <!-- Prompt -->
        <label class="block text-sm text-gray-600">Choose a prompt (optional)</label>
<select id="recPrompt" class="w-full border rounded-md px-3 py-2">
  <option value="">— Pick a prompt —</option>

  <optgroup label="Family & Childhood">
    <option>What was your childhood home like?</option>
    <option>What games or activities did you love as a child?</option>
    <option>What was a holiday or tradition your family always celebrated?</option>
    <option>Tell me about your grandparents or a favorite relative.</option>
  </optgroup>

  <optgroup label="School & Growing Up">
    <option>Who was your favorite teacher, and why?</option>
    <option>What was high school like for you?</option>
    <option>Did you ever get into trouble as a kid or teenager?</option>
    <option>What subject did you love (or hate) most in school?</option>
  </optgroup>

  <optgroup label="Work & Purpose">
    <option>What was your very first job?</option>
    <option>What’s the proudest moment you’ve had at work?</option>
    <option>Who was a mentor who made a difference for you?</option>
    <option>What did you dream of being when you grew up?</option>
  </optgroup>

  <optgroup label="Love & Relationships">
    <option>How did you meet your partner or closest friend?</option>
    <option>How did you know you were in love?</option>
    <option>Tell me about your wedding day (or a special day with someone you loved).</option>
    <option>What’s the best relationship advice you’ve ever received?</option>
  </optgroup>

  <optgroup label="Family Life & Parenting">
    <option>What was it like when you first became a parent?</option>
    <option>Tell me about each of your children’s personalities.</option>
    <option>What family traditions did you create in your own home?</option>
    <option>What do you hope your children remember most about growing up?</option>
  </optgroup>

  <optgroup label="Adventures & Travel">
    <option>What’s your favorite vacation memory?</option>
    <option>What’s the most beautiful place you’ve ever seen?</option>
    <option>Tell me about a time you got lost while traveling.</option>
    <option>What adventure will you never forget?</option>
  </optgroup>

  <optgroup label="Challenges & Triumphs">
    <option>What’s the bravest thing you’ve ever done?</option>
    <option>Tell me about a hard time and how you got through it.</option>
    <option>What’s something you failed at but learned from?</option>
    <option>Have you ever had to start over in life?</option>
  </optgroup>

  <optgroup label="Life Lessons & Legacy">
    <option>What’s the best advice you ever received?</option>
    <option>What would you tell your younger self?</option>
    <option>What are you most proud of in your life?</option>
    <option>What do you want to be remembered for?</option>
  </optgroup>
</select>

        <!-- Consent -->
        <label class="flex items-start gap-2 text-sm text-gray-600">
          <input id="recConsent" type="checkbox" class="mt-1">
          I agree to have this recording stored and processed for the purpose of preserving my story.
        </label>

        <!-- Optional Photo -->
        <div>
          <label class="block text-sm text-gray-600">Add a photo (optional)</label>
          <input id="recPhoto" type="file" accept="image/jpeg,image/png,image/webp" class="w-full border rounded-md px-3 py-2" />
          <div id="recPhotoPreviewWrap" class="mt-2 hidden">
            <div class="flex items-center gap-3">
              <img id="recPhotoPreview" class="w-16 h-16 object-cover rounded-md border flex-shrink-0" alt="Selected photo preview" />
              <div class="flex-1 min-w-0">
                <p class="text-xs text-gray-500 break-words">Photo added ✓</p>
                <p class="text-xs text-gray-400">Max 1600px, compressed</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Meter + Timer -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <canvas id="recMeter" width="140" height="14" class="rounded bg-gray-100"></canvas>
            <span id="recStatus" class="text-sm text-gray-600">Ready</span>
          </div>
          <span id="recTimer" class="text-sm font-mono text-gray-700">00:00</span>
        </div>

        <!-- IMPROVED: Upload progress indicator - FIXED: Only changed progress steps to use smaller text on mobile -->
        <div id="uploadProgress" class="upload-progress hidden">
          <div class="progress-steps">
            <div class="progress-step" id="step-uploading">Uploading</div>
            <div class="progress-step" id="step-processing">Processing</div>
            <div class="progress-step" id="step-generating">Generating</div>
            <div class="progress-step" id="step-complete">Complete</div>
          </div>
          <div class="text-center">
            <div class="loading-spinner"></div>
            <span id="uploadStatusText">Preparing your story...</span>
          </div>
          <p class="text-xs text-gray-500 text-center mt-2">This usually takes 30-60 seconds</p>
        </div>

        <div id="uploadMsg" class="text-sm text-gray-600 hidden"></div>
      </div>
      
      <!-- Fixed bottom section for action buttons -->
      <div id="actionButtons" class="p-4 border-t bg-gray-50 flex-shrink-0">
        <!-- Controls -->
        <div class="flex items-center gap-3 mb-3">
          <button id="btnRecord" class="btn-primary px-4 py-2 rounded-lg">Record</button>
          <button id="btnPause"  class="btn-secondary px-4 py-2 rounded-lg hidden">Pause</button>
          <button id="btnResume" class="btn-primary px-4 py-2 rounded-lg hidden">Resume</button>
          <button id="btnStop"   class="btn-secondary px-4 py-2 rounded-lg hidden">Stop</button>
        </div>

        <!-- IMPROVED: Playback with better button order -->
        <div id="playbackWrap" class="hidden space-y-3">
          <audio id="recAudio" controls class="w-full"></audio>
          <div class="flex items-center justify-between gap-3">
            <button id="btnRerecord" class="btn-secondary px-4 py-2 rounded-lg">Re-record</button>
            <button id="btnUpload" class="btn-primary px-6 py-3 rounded-lg font-semibold text-base">Use This Story</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] p-4 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[95vh] flex flex-col my-4">
      <div class="flex items-center justify-between p-4 border-b flex-shrink-0">
        <div class="flex items-center gap-2">
          <img src="logo.png" alt="Stories of You" class="h-6 w-auto" />
          <span class="text-sm font-semibold" style="color:var(--brand-navy)">Login to Your Storyboard</span>
        </div>
        <button id="loginClose" class="text-gray-400 hover:text-gray-600 text-2xl leading-none" aria-label="Close">&times;</button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto flex-1">
        <!-- Login Form -->
        <div id="loginForm">
          <div class="text-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Welcome Back</h2>
            <p class="text-sm text-gray-600">Enter your email to receive a magic link</p>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input 
                id="loginEmail" 
                type="email" 
                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" 
                placeholder="your@email.com"
                required 
              />
            </div>
            
            <button 
              id="sendLoginCode" 
              class="btn-primary w-full px-4 py-3 rounded-lg font-medium"
            >
              Send Magic Link
            </button>
          </div>
        </div>

        <!-- Magic Link Instructions -->
        <div id="magicLinkForm" class="hidden">
          <div class="text-center mb-6">
            <div class="text-green-600 mb-4">
              <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Check Your Email</h2>
            <p class="text-sm text-gray-600 mb-4">We sent a magic link to <span id="magicLinkEmailDisplay" class="font-medium"></span></p>
            <p class="text-sm text-gray-500">Click the link in your email to access your storyboard. The link will expire in 10 minutes.</p>
          </div>
          
          <div class="space-y-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <p class="text-sm text-blue-800 font-medium">Can't find the email?</p>
                  <p class="text-xs text-blue-600 mt-1">Check your spam folder or try requesting a new link below.</p>
                </div>
              </div>
            </div>
            
            <div class="flex gap-3">
              <button 
                id="resendMagicLink" 
                class="btn-secondary flex-1 px-4 py-3 rounded-lg font-medium"
              >
                Send New Link
              </button>
              <button 
                id="changeEmail" 
                class="btn-secondary px-4 py-3 rounded-lg font-medium"
              >
                Change Email
              </button>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loginLoading" class="hidden text-center py-8">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p class="text-sm text-gray-600">Processing...</p>
        </div>

        <!-- Success State -->
        <div id="loginSuccess" class="hidden text-center py-8">
          <div class="text-green-600 mb-4">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Login Successful!</h3>
          <p class="text-sm text-gray-600 mb-4">Redirecting to your storyboard...</p>
        </div>

        <!-- Error Messages -->
        <div id="loginError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
          <p id="loginErrorText" class="text-sm text-red-600"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Footer year
    document.getElementById("year").textContent = new Date().getFullYear();

    // Scroll-in animations
    const revealEls=document.querySelectorAll('.reveal');
    const io=new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('visible'); io.unobserve(e.target); }});
    },{threshold:.15});
    revealEls.forEach(el=>io.observe(el));

    // Open recorder
    const recModal = document.getElementById('recModal');
    function openRecorderModal() {
      recModal.classList.remove('hidden');
      // FIXED: Prevent background scrolling on mobile - ONLY using overflow hidden, no position fixed
      document.body.style.overflow = 'hidden';
    }
    
    ['openRecorder','openRecorderBottom','openRecorderNav','openRecorderMobile'].forEach(id=>{
      const el=document.getElementById(id); 
      if(el){el.addEventListener('click', openRecorderModal);}
    });

    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // FAQ functionality
    const tabs = document.querySelectorAll('.faq-tab');
    const categories = document.querySelectorAll('.faq-category');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and categories
        tabs.forEach(t => t.classList.remove('active'));
        categories.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding category
        tab.classList.add('active');
        const targetCategory = document.getElementById(tab.dataset.category);
        if (targetCategory) {
          targetCategory.classList.add('active');
        }
      });
    });
    
    // Accordion functionality
    const faqItems = document.querySelectorAll('.faq-item');
    
    faqItems.forEach(item => {
      const question = item.querySelector('.faq-question');
      const answer = item.querySelector('.faq-answer');
      
      question.addEventListener('click', () => {
        const isOpen = item.classList.contains('open');
        
        // Close all other items in the same category
        const currentCategory = item.closest('.faq-category');
        const categoryItems = currentCategory.querySelectorAll('.faq-item');
        categoryItems.forEach(otherItem => {
          otherItem.classList.remove('open');
          otherItem.querySelector('.faq-answer').classList.add('hidden');
        });
        
        // Toggle current item
        if (!isOpen) {
          item.classList.add('open');
          answer.classList.remove('hidden');
        }
      });
    });
  </script>

  <script>
  (function(){
    const INVOKE_URL = "https://6117txq5ok.execute-api.us-east-2.amazonaws.com";
    const METADATA_WEBHOOK = "https://stories.storiesofyou.ai/api/stories/submit";

    const recModal=document.getElementById('recModal');
    const closeRec=document.getElementById('recClose');
    const nameEl=document.getElementById('recName');
    const emailEl=document.getElementById('recEmail');
    const promptEl=document.getElementById('recPrompt');
    const consentEl=document.getElementById('recConsent');
    const photoInput=document.getElementById('recPhoto');
    const photoPreviewWrap=document.getElementById('recPhotoPreviewWrap');
    const photoPreview=document.getElementById('recPhotoPreview');

    const meterCv=document.getElementById('recMeter');
    const mtx=meterCv.getContext('2d');
    const statusEl=document.getElementById('recStatus');
    const timerEl=document.getElementById('recTimer');
    const btnRecord=document.getElementById('btnRecord');
    const btnPause=document.getElementById('btnPause');
    const btnResume=document.getElementById('btnResume');
    const btnStop=document.getElementById('btnStop');
    const pbWrap=document.getElementById('playbackWrap');
    const audioEl=document.getElementById('recAudio');
    const btnRerec=document.getElementById('btnRerecord');
    const btnUpload=document.getElementById('btnUpload');
    const uploadMsg=document.getElementById('uploadMsg');
    
    // IMPROVED: Upload progress elements
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatusText = document.getElementById('uploadStatusText');
    const stepUploading = document.getElementById('step-uploading');
    const stepProcessing = document.getElementById('step-processing');
    const stepGenerating = document.getElementById('step-generating');
    const stepComplete = document.getElementById('step-complete');

    let mediaStream, mediaRecorder, chunks=[];
    let audioCtx, analyser, dataArray, meterAnim;
    let startTime, timerInt, blob, mimeType;
    let photoFile=null;

    async function getPresign(ext, type){
      const qs = new URLSearchParams({ ext, type });
      const url = `${INVOKE_URL}/presign?${qs.toString()}`;
      const res = await fetch(url, { method:'GET' });
      if(!res.ok){
        const t = await res.text().catch(()=>res.statusText);
        throw new Error(`Failed to get presign (${res.status}): ${t}`);
      }
      return res.json();
    }

    async function s3FormUpload(presign, file){
      const fd = new FormData();
      for(const [k,v] of Object.entries(presign.fields||{})){
        fd.append(k, v);
      }
      if(!('key' in (presign.fields||{})) && presign.key){
        fd.append('key', presign.key);
      }
      fd.append('file', file);

      const res = await fetch(presign.url, { method:'POST', body:fd });
      if(!res.ok){
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`S3 upload failed (${res.status}): ${txt}`);
      }
      return presign.key;
    }

    photoInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f){ photoFile=null; photoPreviewWrap.classList.add('hidden'); return; }
      const ok = ['image/jpeg','image/png','image/webp'].includes(f.type);
      if(!ok){ alert('Please choose a JPG, PNG, or WebP image.'); photoInput.value=''; return; }
      const url = URL.createObjectURL(f);
      photoPreview.src = url;
      photoPreviewWrap.classList.remove('hidden');
      try{
        photoFile = await resizeImage(f, 1600, 0.85);
      }catch(_){
        photoFile = f;
      }
    });

    function resizeImage(file, maxDim, quality){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>{
          let {width:w, height:h} = img;
          const scale = Math.min(1, maxDim/Math.max(w,h));
          const cw = Math.round(w*scale), ch = Math.round(h*scale);
          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0,cw,ch);
          canvas.toBlob(b=>{
            if(!b) return reject(new Error('toBlob failed'));
            resolve(new File([b], 'photo.jpg', {type:'image/jpeg'}));
          }, 'image/jpeg', quality);
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    closeRec.addEventListener('click', resetAndClose);
    function resetAndClose(){
      try{
        if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop();
        if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
        if(audioCtx) audioCtx.close();
        if(meterAnim) cancelAnimationFrame(meterAnim);
        if(timerInt) clearInterval(timerInt);
      }catch(e){}
      recModal.classList.add('hidden');
      
      // FIXED: Restore background scrolling - ONLY restore overflow
      document.body.style.overflow = '';
      
      statusEl.textContent='Ready';
      timerEl.textContent='00:00';
      pbWrap.classList.add('hidden');
      btnRecord.classList.remove('hidden');
      btnPause.classList.add('hidden'); btnResume.classList.add('hidden'); btnStop.classList.add('hidden');
      uploadMsg.classList.add('hidden'); uploadMsg.textContent='';
      uploadProgress.classList.add('hidden'); // IMPROVED: Hide progress indicator
      chunks=[]; blob=null; if(audioEl) audioEl.src='';
      [nameEl,emailEl,promptEl].forEach(i=>{ if(i) i.value=''; });
      if(consentEl) consentEl.checked=false;
      photoInput.value=''; photoFile=null; photoPreviewWrap.classList.add('hidden');
      
      // IMPROVED: Reset button states
      btnUpload.disabled = false;
      btnRerec.disabled = false;
      btnUpload.innerHTML = 'Use This Story';
    }

    async function startRecording(){
      try{
        mimeType = MediaRecorder.isTypeSupported('audio/mp4;codecs=aac') ? 'audio/mp4'
                 : MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm' : '';
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(mediaStream, mimeType ? {mimeType} : undefined);
        chunks=[];

        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const src = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        src.connect(analyser); drawMeter();

        mediaRecorder.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
        mediaRecorder.onstart=()=>{
          statusEl.textContent='Recording…'; startTimer();
          btnRecord.classList.add('hidden'); btnPause.classList.remove('hidden'); btnStop.classList.remove('hidden');
        };
        mediaRecorder.onpause =()=>{ statusEl.textContent='Paused'; stopTimer(); };
        mediaRecorder.onresume=()=>{ statusEl.textContent='Recording…'; startTimer(true); };
        mediaRecorder.onstop  =()=>{
          stopMeter(); stopTimer();
          blob=new Blob(chunks,{type:mimeType||'audio/webm'});
          audioEl.src=URL.createObjectURL(blob);
          pbWrap.classList.remove('hidden');
          btnPause.classList.add('hidden'); btnResume.classList.add('hidden'); btnStop.classList.add('hidden');
          statusEl.textContent='Review your recording';
        };

        mediaRecorder.start();
      }catch(err){
        console.error(err);
        statusEl.textContent='Microphone access blocked. Please allow mic.';
      }
    }
    function pauseRecording(){ if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.pause(); btnPause.classList.add('hidden'); btnResume.classList.remove('hidden'); } }
    function resumeRecording(){ if(mediaRecorder && mediaRecorder.state==='paused'){ mediaRecorder.resume(); btnResume.classList.add('hidden'); btnPause.classList.remove('hidden'); } }
    function stopRecording(){ if(mediaRecorder && (mediaRecorder.state==='recording'||mediaRecorder.state==='paused')){ mediaRecorder.stop(); mediaStream.getTracks().forEach(t=>t.stop()); } }

    function drawMeter(){
      function frame(){
        analyser.getByteTimeDomainData(dataArray);
        let peak=0; for(let i=0;i<dataArray.length;i++){ const v=Math.abs(dataArray[i]-128)/128; if(v>peak) peak=v; }
        const pct=Math.min(1,peak*2);
        mtx.clearRect(0,0,meterCv.width,meterCv.height);
        mtx.fillStyle='#e7e3db'; mtx.fillRect(0,0,meterCv.width,meterCv.height);
        mtx.fillStyle=pct>0.8?'#d9534f':'#3d3528';
        mtx.fillRect(0,0,Math.max(6,Math.floor(meterCv.width*pct)),meterCv.height);
        meterAnim=requestAnimationFrame(frame);
      }
      meterAnim=requestAnimationFrame(frame);
    }
    function stopMeter(){ if(meterAnim) cancelAnimationFrame(meterAnim); }
    function startTimer(reset){ if(!reset) startTime=Date.now(); timerInt=setInterval(()=>{ const s=Math.floor((Date.now()-startTime)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); timerEl.textContent=`${mm}:${ss}`; },250); }
    function stopTimer(){ if(timerInt) clearInterval(timerInt); }

    function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
    function canUpload(){
      if(!nameEl.value.trim()){ uploadMsg.textContent="Please enter your name."; uploadMsg.classList.remove('hidden'); return false; }
      if(!isValidEmail(emailEl.value.trim())){ uploadMsg.textContent="Please enter a valid email."; uploadMsg.classList.remove('hidden'); return false; }
      if(consentEl && !consentEl.checked){ uploadMsg.textContent="Please accept the consent box."; uploadMsg.classList.remove('hidden'); return false; }
      return true;
    }

    // IMPROVED: Enhanced upload function with progress tracking
    async function uploadBlob(){
      if(!blob) return;
      if(!canUpload()) return;
      
      // IMPROVED: Disable buttons and show progress
      btnUpload.disabled = true;
      btnRerec.disabled = true;
      btnUpload.innerHTML = '<span class="loading-spinner"></span>Uploading...';
      uploadMsg.classList.add('hidden');
      uploadProgress.classList.remove('hidden');
      
      // IMPROVED: Update progress steps
      function updateProgress(step, text) {
        // Reset all steps
        [stepUploading, stepProcessing, stepGenerating, stepComplete].forEach(s => {
          s.classList.remove('active', 'completed');
        });
        
        // Mark completed steps
        const steps = [stepUploading, stepProcessing, stepGenerating, stepComplete];
        const currentIndex = steps.indexOf(step);
        
        for (let i = 0; i < currentIndex; i++) {
          steps[i].classList.add('completed');
        }
        
        // Mark current step
        step.classList.add('active');
        uploadStatusText.textContent = text;
      }

      const audioType = mimeType || 'audio/webm';
      const audioExt  = (audioType==='audio/mp4') ? 'm4a' : 'webm';
      const audioFile = new File([blob], `story.${audioExt}`, { type: audioType });

      try{
        updateProgress(stepUploading, 'Preparing upload slot (audio)...');
        const presignAudio = await getPresign(audioExt, audioType);

        updateProgress(stepUploading, 'Uploading audio file...');
        const audioKey = await s3FormUpload(presignAudio, audioFile);

        let photoKey = null;
        if(photoFile){
          const pType = photoFile.type || 'image/jpeg';
          const pExt = pType.endsWith('png') ? 'png' : pType.endsWith('webp') ? 'webp' : 'jpg';
          updateProgress(stepUploading, 'Uploading photo...');
          const presignPhoto = await getPresign(pExt, pType);
          photoKey = await s3FormUpload(presignPhoto, photoFile);
        }

        updateProgress(stepProcessing, 'Processing your story...');

        if(METADATA_WEBHOOK){
          const meta = {
            name: nameEl.value.trim(),
            email: emailEl.value.trim(),
            prompt: promptEl.value || '',
            audio_key: audioKey,
            photo_key: photoKey,
            recorded_at: new Date().toISOString(),
            user_agent: navigator.userAgent
          };
          
          updateProgress(stepGenerating, 'Creating your story page...');
          
          const res = await fetch(METADATA_WEBHOOK, {
            method:'POST',
            headers:{ 'content-type':'application/json' },
            body: JSON.stringify(meta)
          });
          
          if(!res.ok){
            throw new Error('Processing failed: ' + res.status);
          } else {
            updateProgress(stepComplete, 'Story created successfully!');
            uploadStatusText.textContent = 'Your story is being processed and will be emailed to you shortly.';
            
            // IMPROVED: Success state
            setTimeout(() => {
              uploadProgress.classList.add('hidden');
              uploadMsg.classList.remove('hidden');
              uploadMsg.innerHTML = '✅ <strong>Success!</strong> Your story has been submitted and will be emailed to you once processed.';
              uploadMsg.style.color = '#059669';
              uploadMsg.style.background = '#d1fae5';
              uploadMsg.style.padding = '1rem';
              uploadMsg.style.borderRadius = '8px';
              uploadMsg.style.border = '1px solid #a7f3d0';
            }, 1500);
          }
        }

        setTimeout(()=>resetAndClose(),4000);
      }catch(e){
        console.error(e);
        
        // IMPROVED: Error state
        uploadProgress.classList.add('hidden');
        uploadMsg.classList.remove('hidden');
        uploadMsg.innerHTML = `⚠ <strong>Upload failed:</strong> ${e?.message || 'Please try again.'}`;
        uploadMsg.style.color = '#dc2626';
        uploadMsg.style.background = '#fee2e2';
        uploadMsg.style.padding = '1rem';
        uploadMsg.style.borderRadius = '8px';
        uploadMsg.style.border = '1px solid #fecaca';
        
        // IMPROVED: Re-enable buttons on error
        btnUpload.disabled = false;
        btnRerec.disabled = false;
        btnUpload.innerHTML = 'Use This Story';
      }
    }

    btnRecord.addEventListener('click',startRecording);
    btnPause .addEventListener('click',pauseRecording);
    btnResume.addEventListener('click',resumeRecording);
    btnStop  .addEventListener('click',stopRecording);
    btnRerec.addEventListener('click',()=>{
      pbWrap.classList.add('hidden'); statusEl.textContent='Ready'; timerEl.textContent='00:00';
      chunks=[]; blob=null; audioEl.src=''; btnRecord.classList.remove('hidden');
      uploadMsg.classList.add('hidden'); uploadProgress.classList.add('hidden'); // IMPROVED: Reset states
      btnUpload.disabled = false; btnRerec.disabled = false; btnUpload.innerHTML = 'Use This Story';
    });
    btnUpload.addEventListener('click',uploadBlob);
  })();

  // Login Modal Functionality
  (function(){
    const N8N_BASE_URL = "https://storiesofyou.ai/api"; // CloudFront proxy to n8n
    
    const loginModal = document.getElementById('loginModal');
    const loginClose = document.getElementById('loginClose');
    const openLoginModal = document.getElementById('openLoginModal');
    const openLoginMobile = document.getElementById('openLoginMobile');
    
    const loginForm = document.getElementById('loginForm');
    const magicLinkForm = document.getElementById('magicLinkForm');
    const loginLoading = document.getElementById('loginLoading');
    const loginSuccess = document.getElementById('loginSuccess');
    const loginError = document.getElementById('loginError');
    const loginErrorText = document.getElementById('loginErrorText');
    
    const loginEmail = document.getElementById('loginEmail');
    const sendLoginCode = document.getElementById('sendLoginCode');
    const magicLinkEmailDisplay = document.getElementById('magicLinkEmailDisplay');
    const resendMagicLinkBtn = document.getElementById('resendMagicLink');
    const changeEmail = document.getElementById('changeEmail');
    
    let currentEmail = '';

    // Open login modal
    function openLogin() {
      loginModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      resetLoginForm();
    }
    
    // Close login modal
    function closeLogin() {
      loginModal.classList.add('hidden');
      document.body.style.overflow = '';
      resetLoginForm();
    }
    
    // Reset login form to initial state
    function resetLoginForm() {
      loginForm.classList.remove('hidden');
      magicLinkForm.classList.add('hidden');
      loginLoading.classList.add('hidden');
      loginSuccess.classList.add('hidden');
      loginError.classList.add('hidden');
      loginEmail.value = '';
      currentEmail = '';
    }
    
    // Show error message
    function showError(message) {
      loginErrorText.textContent = message;
      loginError.classList.remove('hidden');
      setTimeout(() => {
        loginError.classList.add('hidden');
      }, 5000);
    }
    
    // Send magic link
    async function sendMagicLink() {
      const email = loginEmail.value.trim();
      
      if (!email || !email.includes('@')) {
        showError('Please enter a valid email address');
        return;
      }
      
      currentEmail = email;
      
      // Show loading state
      loginForm.classList.add('hidden');
      loginLoading.classList.remove('hidden');
      loginError.classList.add('hidden');
      
      try {
        const response = await fetch(`${N8N_BASE_URL}/webhook/generate-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show magic link instructions
          loginLoading.classList.add('hidden');
          magicLinkForm.classList.remove('hidden');
          magicLinkEmailDisplay.textContent = email;
        } else {
          throw new Error(data.message || 'Failed to send magic link');
        }
      } catch (error) {
        console.error('Send magic link error:', error);
        loginLoading.classList.add('hidden');
        loginForm.classList.remove('hidden');
        showError(error.message || 'Failed to send magic link. Please try again.');
      }
    }
    
    // Resend magic link
    async function resendMagicLink() {
      if (!currentEmail) {
        showError('No email address found. Please start over.');
        return;
      }
      
      // Show loading state
      magicLinkForm.classList.add('hidden');
      loginLoading.classList.remove('hidden');
      loginError.classList.add('hidden');
      
      try {
        const response = await fetch(`${N8N_BASE_URL}/webhook/generate-otp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: currentEmail })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show magic link form again
          loginLoading.classList.add('hidden');
          magicLinkForm.classList.remove('hidden');
        } else {
          throw new Error(data.message || 'Failed to resend magic link');
        }
      } catch (error) {
        console.error('Resend magic link error:', error);
        loginLoading.classList.add('hidden');
        magicLinkForm.classList.remove('hidden');
        showError(error.message || 'Failed to resend magic link. Please try again.');
      }
    }
    
    // Change email address
    function changeEmailAddress() {
      magicLinkForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      loginEmail.focus();
    }
    
    // Event listeners
    openLoginModal?.addEventListener('click', openLogin);
    openLoginMobile?.addEventListener('click', openLogin);
    loginClose?.addEventListener('click', closeLogin);
    sendLoginCode?.addEventListener('click', sendMagicLink);
    resendMagicLinkBtn?.addEventListener('click', resendMagicLink);
    changeEmail?.addEventListener('click', changeEmailAddress);
    
    // Allow Enter key to submit forms
    loginEmail?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMagicLink();
      }
    });
    
    // Close modal when clicking outside
    loginModal?.addEventListener('click', (e) => {
      if (e.target === loginModal) {
        closeLogin();
      }
    });
  })();
  </script>
</body>
</html>

